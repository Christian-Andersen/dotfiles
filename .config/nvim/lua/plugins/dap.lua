-- ============================================================================\n-- DAP (DEBUG ADAPTER PROTOCOL)\n-- ============================================================================\n-- nvim-dap and nvim-dap-ui: Debugger support for Neovim\n-- \n-- Features:\n--   - Breakpoints: Set conditional breakpoints and toggle them with <leader>b\n--   - Stepping: Step into, over, and out of functions with F1, F2, F3\n--   - Continue/Pause: Start, continue, or pause execution with F5\n--   - Watch/Expressions: Inspect variables and evaluate expressions\n--   - Call Stack: Navigate through function calls\n--   - Debug UI: Visual interface for viewing debug state\n--   - Multiple language support through DAP adapters\n--\n-- Keybindings:\n--   F5     : Debug Start/Continue\n--   F1     : Step Into (enter function)\n--   F2     : Step Over (skip over function)\n--   F3     : Step Out (exit current function)\n--   <leader>b  : Toggle breakpoint on current line\n--   <leader>B  : Set conditional breakpoint\n--   F7     : Toggle debug UI\n--\n-- Repos: https://github.com/mfussenegger/nvim-dap\n--        https://github.com/rcarriga/nvim-dap-ui\n-- ============================================================================\n\nreturn {\n    'mfussenegger/nvim-dap',\n    \n    -- Dependencies for debugging functionality\n    dependencies = {\n        -- DAP UI: Provides a visual interface for debugging\n        'rcarriga/nvim-dap-ui',\n        -- Async I/O library needed by nvim-dap-ui\n        'nvim-neotest/nvim-nio',\n        -- Mason: Package manager for LSPs, formatters, and DAP adapters\n        'mason-org/mason.nvim',\n        -- Mason integration for DAP: Automatically installs DAP adapters\n        'jay-babu/mason-nvim-dap.nvim',\n        -- Go-specific DAP support with delve debugger integration\n        'leoluz/nvim-dap-go',\n    },\n    \n    -- Keybindings for debugging operations\n    keys = {\n        -- F5: Start or continue debugging\n        {\n            '<F5>',\n            function()\n                require('dap').continue()\n            end,\n            desc = 'Debug: Start/Continue',\n        },\n        -- F1: Step into the next function\n        {\n            '<F1>',\n            function()\n                require('dap').step_into()\n            end,\n            desc = 'Debug: Step Into',\n        },\n        -- F2: Step over the next line (execute function without entering it)\n        {\n            '<F2>',\n            function()\n                require('dap').step_over()\n            end,\n            desc = 'Debug: Step Over',\n        },\n        -- F3: Step out of the current function\n        {\n            '<F3>',\n            function()\n                require('dap').step_out()\n            end,\n            desc = 'Debug: Step Out',\n        },\n        -- <leader>b: Toggle breakpoint on the current line\n        {\n            '<leader>b',\n            function()\n                require('dap').toggle_breakpoint()\n            end,\n            desc = 'Debug: Toggle Breakpoint',\n        },\n        -- <leader>B: Set a conditional breakpoint (user enters condition)\n        {\n            '<leader>B',\n            function()\n                require('dap').set_breakpoint(vim.fn.input 'Breakpoint condition: ')\n            end,\n            desc = 'Debug: Set Breakpoint',\n        },\n        -- F7: Toggle the debug UI window\n        -- Shows/hides the panel with variables, call stack, breakpoints, etc.\n        {\n            '<F7>',\n            function()\n                require('dapui').toggle()\n            end,\n            desc = 'Debug: See last session result.',\n        },\n    },\n    \n    -- Configuration function: runs after the plugin is loaded\n    config = function()\n        -- Load the DAP module for controlling debugging\n        local dap = require 'dap'\n        -- Load the DAP UI module for visual debugging interface\n        local dapui = require 'dapui'\n\n        -- Auto-install DAP adapters using Mason\n        require('mason-nvim-dap').setup {\n            -- Automatically install missing DAP adapters when needed\n            automatic_installation = true,\n            -- Custom handler functions for specific adapters (can be empty)\n            handlers = {},\n            -- Ensure the delve debugger is installed (for Go debugging)\n            ensure_installed = {\n                'delve',\n            },\n        }\n\n        -- Configure the DAP UI appearance and behavior\n        dapui.setup {\n            -- Icons for expand/collapse states\n            icons = { \n                expanded = '▾',        -- Icon when a section is expanded\n                collapsed = '▸',       -- Icon when a section is collapsed\n                current_frame = '*'    -- Icon marking the current execution frame\n            },\n            -- Control buttons for debugging operations\n            controls = {\n                icons = {\n                    pause = '⏸',       -- Pause icon\n                    play = '▶',        -- Play/continue icon\n                    step_into = '⏎',   -- Step into icon\n                    step_over = '⏭',   -- Step over icon\n                    step_out = '⏮',    -- Step out icon\n                    step_back = 'b',   -- Step backward icon\n                    run_last = '▶▶',   -- Run last icon\n                    terminate = '⏹',   -- Terminate/stop icon\n                    disconnect = '⏏',  -- Disconnect icon\n                },\n            },\n        }\n\n        -- Auto-open the DAP UI when debugging starts\n        -- Triggered when a debug session is initialized\n        dap.listeners.after.event_initialized['dapui_config'] = dapui.open\n        \n        -- Auto-close the DAP UI when debugging ends (terminated)\n        -- Keeps the editor clean when no longer debugging\n        dap.listeners.before.event_terminated['dapui_config'] = dapui.close\n        \n        -- Auto-close the DAP UI when exiting the debugger\n        dap.listeners.before.event_exited['dapui_config'] = dapui.close\n\n        -- Configure Go debugging with delve\n        require('dap-go').setup {\n            delve = {\n                -- Use detached mode on Unix systems (better for debugging)\n                -- vim.fn.has 'win32' == 0 means \"not Windows\"\n                detached = vim.fn.has 'win32' == 0,\n            },\n        }\n    end,\n}
